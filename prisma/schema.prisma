generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Message log for all incoming WhatsApp messages
model Message {
  id                  String      @id @default(uuid())
  phone               String      @db.VarChar(20)
  contractorName      String?     @map("contractor_name") @db.VarChar(255)
  incomingMessage     String      @map("incoming_message") @db.Text
  languageDetected    String?     @map("language_detected") @db.VarChar(10)
  intent              String?     @db.VarChar(50)
  contractNumber      String?     @map("contract_number") @db.VarChar(20)
  isValidFormat       Boolean?    @map("is_valid_format")
  isSpam              Boolean?    @map("is_spam")
  lmStudioLatency     Int?        @map("lm_studio_latency")
  crmLookupLatency    Int?        @map("crm_lookup_latency")
  totalLatency        Int?        @map("total_latency")
  crmStatus           Json?       @map("crm_status")
  responseMessageFr   String?     @map("response_message_fr") @db.Text
  responseMessageAr   String?     @map("response_message_ar") @db.Text
  hasComplaint        Boolean     @default(false) @map("has_complaint")
  complaintType       String?     @map("complaint_type") @db.VarChar(100)
  errorCode           String?     @map("error_code") @db.VarChar(50)
  errorMessage        String?     @map("error_message") @db.Text
  lmStudioFallback    Boolean     @default(false) @map("lm_studio_fallback")
  createdAt           DateTime    @default(now()) @map("created_at")
  updatedAt           DateTime    @updatedAt @map("updated_at")

  complaints          Complaint[]

  @@index([phone])
  @@index([contractNumber])
  @@index([createdAt(sort: Desc)])
  @@map("messages")
}

// Complaints filed by contractors
model Complaint {
  id                String    @id @default(uuid())
  phone             String    @db.VarChar(20)
  contractorName    String?   @map("contractor_name") @db.VarChar(255)
  contractNumber    String    @map("contract_number") @db.VarChar(20)
  complaintType     String    @map("complaint_type") @db.VarChar(100)
  message           String?   @db.Text
  status            String    @default("open") @db.VarChar(50)
  priority          String    @default("medium") @db.VarChar(50)
  assignedTo        String?   @map("assigned_to") @db.VarChar(255)
  escalatedToOrange Boolean   @default(false) @map("escalated_to_orange")
  orangeTicketId    String?   @map("orange_ticket_id") @db.VarChar(100)
  notes             String?   @db.Text
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  messageLogId      String?   @map("message_log_id")
  messageLog        Message?  @relation(fields: [messageLogId], references: [id])
  tickets           Ticket[]

  @@index([status])
  @@index([priority])
  @@index([createdAt(sort: Desc)])
  @@map("complaints")
}

// Tickets for Orange escalation
model Ticket {
  id              String    @id @default(uuid())
  orangeTicketId  String?   @map("orange_ticket_id") @db.VarChar(100)
  status          String    @default("open") @db.VarChar(50)
  priority        String    @default("medium") @db.VarChar(20)
  assignedTo      String?   @map("assigned_to") @db.VarChar(255)
  resolutionNotes String?   @map("resolution_notes") @db.Text
  createdBy       String?   @map("created_by") @db.VarChar(255)
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  complaintId     String    @map("complaint_id")
  complaint       Complaint @relation(fields: [complaintId], references: [id])

  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@map("tickets")
}

// Magic links for passwordless authentication
model MagicLink {
  id          String    @id @default(uuid())
  email       String    @db.VarChar(255)
  token       String    @unique @db.VarChar(255)
  used        Boolean   @default(false)
  usedAt      DateTime? @map("used_at")
  ipAddress   String?   @map("ip_address") @db.VarChar(50)
  userAgent   String?   @map("user_agent") @db.Text
  expiresAt   DateTime  @map("expires_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  @@index([email])
  @@index([token])
  @@map("magic_links")
}

// User sessions
model Session {
  id          String    @id @default(uuid())
  email       String    @db.VarChar(255)
  token       String    @db.VarChar(500)
  role        String    @default("bo_team") @db.VarChar(50)
  ipAddress   String?   @map("ip_address") @db.VarChar(50)
  userAgent   String?   @map("user_agent") @db.Text
  expiresAt   DateTime  @map("expires_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  @@index([email])
  @@index([token])
  @@map("sessions")
}

// Audit logs for compliance and tracking
model AuditLog {
  id          String    @id @default(uuid())
  eventType   String    @map("event_type") @db.VarChar(100)
  actor       String?   @db.VarChar(255)
  resourceId  String?   @map("resource_id")
  action      String?   @db.VarChar(50)
  changes     Json?
  ipAddress   String?   @map("ip_address") @db.VarChar(50)
  userAgent   String?   @map("user_agent") @db.Text
  createdAt   DateTime  @default(now()) @map("created_at")

  @@index([actor])
  @@index([eventType])
  @@index([createdAt(sort: Desc)])
  @@map("audit_logs")
}

// Message templates for bilingual responses
model MessageTemplate {
  id            String    @id @default(uuid())
  etat          String    @db.VarChar(100)
  sousEtat      String?   @map("sous_etat") @db.VarChar(100)
  sousEtat2     String?   @map("sous_etat_2") @db.VarChar(100)
  messageFr     String    @map("message_fr") @db.Text
  messageAr     String    @map("message_ar") @db.Text
  allowComplaint Boolean  @default(false) @map("allow_complaint")
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  @@unique([etat, sousEtat, sousEtat2])
  @@map("message_templates")
}

// Admin users for dashboard access
model AdminUser {
  id          String    @id @default(uuid())
  email       String    @unique @db.VarChar(255)
  name        String?   @db.VarChar(255)
  role        String    @default("bo_team") @db.VarChar(50)
  isActive    Boolean   @default(true) @map("is_active")
  lastLoginAt DateTime? @map("last_login_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@map("admin_users")
}
